name: CD - Publish to NuGet

on:
  push:
    branches:
      - main # ç•¶ main åˆ†æ”¯æœ‰æ–° commit æ™‚è§¸ç™¼
  release:
    types: [published]
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

permissions:
  contents: write
  packages: write

env:
  DOTNET_VERSION: '8.0.x'
  PROJECT_PATH: 'ReplaceText/ReplaceText.csproj'
  PACKAGE_OUTPUT_DIR: 'ReplaceText/nupkg'

jobs:
  publish:
    name: Build and Publish to NuGet
    runs-on: ubuntu-latest
    # Expose whether this job created a Release and the resolved version so
    # downstream jobs can act (e.g. build platform binaries and attach
    # release assets) either when this workflow created the Release or when
    # the workflow is triggered by a release event.
    outputs:
      release_created: ${{ steps.set_release_created.outputs.release_created }}
      version: ${{ steps.get_version.outputs.VERSION }}

    steps:
    - name: ğŸ“¥ Checkout ç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # å®Œæ•´çš„ Git æ­·å²è¨˜éŒ„ï¼Œç”¨æ–¼ç‰ˆæœ¬è™Ÿç”Ÿæˆ

    - name: ğŸ”§ è¨­å®š .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ğŸ“ å–å¾—ç‰ˆæœ¬è™Ÿ
      id: get_version
      run: |
        # For pushes to main or when manually triggered, read <Version> from the csproj
        if [[ "$GITHUB_EVENT_NAME" == "workflow_dispatch" || "$GITHUB_REF" == "refs/heads/main" ]]; then
          VERSION=$(grep -Po '(?<=<Version>).*?(?=</Version>)' "$PROJECT_PATH" || true)
          if [ -z "$VERSION" ]; then
            echo "âŒ ç„¡æ³•å¾ $PROJECT_PATH å–å¾— <Version>ï¼Œè«‹åœ¨ csproj ä¸­è¨­å®š <Version>ã€‚" >&2
            exit 1
          fi
        else
          # Fallback developer build version for other refs
          VERSION="1.0.0-dev.${{ github.run_number }}"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ“¦ ç‰ˆæœ¬è™Ÿ: $VERSION"

    - name: ğŸ”¨ é‚„åŸç›¸ä¾å¥—ä»¶
      run: dotnet restore ${{ env.PROJECT_PATH }}

    - name: ğŸ” æª¢æŸ¥ NuGet æ˜¯å¦å·²å­˜åœ¨æ­¤ç‰ˆæœ¬
      id: check_nuget
      run: |
        PACKAGE_ID="Duotify.ReplaceText"
        PACKAGE_ID_LOWER=$(echo "$PACKAGE_ID" | tr '[:upper:]' '[:lower:]')
        INDEX_URL="https://api.nuget.org/v3-flatcontainer/${PACKAGE_ID_LOWER}/index.json"
        echo "æŸ¥è©¢ NuGet: $INDEX_URL"
        RESP=$(curl -sS "$INDEX_URL" || true)
        if [ -z "$RESP" ]; then
          # å¦‚æœæ‰¾ä¸åˆ° index.jsonï¼Œä»£è¡¨æ­¤å¥—ä»¶ ID å°šæœªä¸Šå‚³é
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "ğŸ”” NuGet ä¸Šæ‰¾ä¸åˆ°å¥—ä»¶ $PACKAGE_IDï¼Œå°‡æœƒç™¼ä½ˆæ–°ç‰ˆæœ¬ã€‚"
          exit 0
        fi
        # æª¢æŸ¥ç‰ˆæœ¬æ˜¯å¦åœ¨ç‰ˆæœ¬æ¸…å–®ä¸­
        if echo "$RESP" | grep -q "\"${{ steps.get_version.outputs.VERSION }}\""; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "â„¹ï¸ ç‰ˆæœ¬ ${{ steps.get_version.outputs.VERSION }} å·²å­˜åœ¨æ–¼ NuGet Galleryã€‚å°‡è·³éç™¼ä½ˆèˆ‡å»ºç«‹ Releaseã€‚"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "ğŸ”” ç‰ˆæœ¬ ${{ steps.get_version.outputs.VERSION }} ä¸åœ¨ NuGet Galleryï¼Œå°‡ç™¼ä½ˆæ–°ç‰ˆä¸¦å»ºç«‹ Releaseã€‚"
        fi

    - name: ğŸ—ï¸ å»ºæ§‹å°ˆæ¡ˆ
      run: dotnet build ${{ env.PROJECT_PATH }} -c Release --no-restore

    - name: ğŸ“¦ æ‰“åŒ… NuGet å¥—ä»¶ (åƒ…åœ¨ NuGet å°šæœªæœ‰æ­¤ç‰ˆæœ¬æ™‚åŸ·è¡Œ)
      id: pack
      if: steps.check_nuget.outputs.exists == 'false'
      run: |
        dotnet pack ${{ env.PROJECT_PATH }} \
          -c Release \
          --no-build \
          --no-restore \
          -o ${{ env.PACKAGE_OUTPUT_DIR }} \
          -p:PackageVersion=${{ steps.get_version.outputs.VERSION }}
        # è¨˜éŒ„ç”¢ç”Ÿçš„ nupkg è·¯å¾‘ï¼Œä¾›å¾ŒçºŒ push èˆ‡ä¸Šå‚³åˆ° Release ä½¿ç”¨
        NUPKG_PATH=$(ls ${{ env.PACKAGE_OUTPUT_DIR }}/*.nupkg | head -n1)
        echo "NUPKG_PATH=$NUPKG_PATH" >> $GITHUB_OUTPUT

    - name: ğŸ“‹ åˆ—å‡ºå¥—ä»¶å…§å®¹ (åƒ…åœ¨ NuGet å°šæœªæœ‰æ­¤ç‰ˆæœ¬æ™‚åŸ·è¡Œ)
      if: steps.check_nuget.outputs.exists == 'false'
      run: |
        echo "ğŸ” å·²ç”¢ç”Ÿçš„ NuGet å¥—ä»¶ï¼š"
        ls -lh ${{ env.PACKAGE_OUTPUT_DIR }}

    - name: âœ… é©—è­‰å¥—ä»¶å…§å®¹ (åƒ…åœ¨ NuGet å°šæœªæœ‰æ­¤ç‰ˆæœ¬æ™‚åŸ·è¡Œ)
      if: steps.check_nuget.outputs.exists == 'false'
      run: |
        echo "ğŸ” é©—è­‰ NuGet å¥—ä»¶å…§å®¹..."
        for nupkg in ${{ env.PACKAGE_OUTPUT_DIR }}/*.nupkg; do
          echo "ğŸ“¦ å¥—ä»¶: $(basename $nupkg)"
          unzip -l "$nupkg" | grep -E '\.(dll|exe|pdb)$' || true
        done

    - name: ğŸš€ ç™¼ä½ˆåˆ° NuGet.org (åƒ…åœ¨ NuGet å°šæœªæœ‰æ­¤ç‰ˆæœ¬æ™‚åŸ·è¡Œ)
      if: steps.check_nuget.outputs.exists == 'false'
      run: |
        echo "æº–å‚™å°‡å¥—ä»¶æ¨é€åˆ° NuGet.orgï¼š${{ steps.pack.outputs.NUPKG_PATH }}"
        dotnet nuget push "${{ steps.pack.outputs.NUPKG_PATH }}" \
          --api-key ${{ secrets.NUGET_API_KEY }} \
          --source https://api.nuget.org/v3/index.json \
          --skip-duplicate

    - name: ğŸ“¤ ä¸Šå‚³å¥—ä»¶ä½œç‚º Artifacts (åƒ…åœ¨ NuGet å°šæœªæœ‰æ­¤ç‰ˆæœ¬æ™‚åŸ·è¡Œ)
      if: steps.check_nuget.outputs.exists == 'false'
      uses: actions/upload-artifact@v4
      with:
        name: nuget-package-${{ steps.get_version.outputs.VERSION }}
        path: ${{ steps.pack.outputs.NUPKG_PATH }}
        retention-days: 30

    - name: ğŸ“ å»ºç«‹ Release ä¸¦ä¸Šå‚³ nupkgï¼ˆåƒ…åœ¨ NuGet å°šæœªæœ‰æ­¤ç‰ˆæœ¬æ™‚åŸ·è¡Œï¼‰
      if: steps.check_nuget.outputs.exists == 'false'
      uses: ncipollo/release-action@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag: v${{ steps.get_version.outputs.VERSION }}
        name: Duotify.ReplaceText ${{ steps.get_version.outputs.VERSION }}
        body: |
          ## ğŸ‰ Duotify.ReplaceText ${{ steps.get_version.outputs.VERSION }} å·²ç™¼ä½ˆï¼

          ### å®‰è£æ–¹å¼

          ```bash
          dotnet tool install --global Duotify.ReplaceText
          ```

          ### æ›´æ–°æ–¹å¼

          ```bash
          dotnet tool update --global Duotify.ReplaceText
          ```

          ### ğŸ“¦ å¥—ä»¶é€£çµ

          - [NuGet Gallery](https://www.nuget.org/packages/Duotify.ReplaceText/${{ steps.get_version.outputs.VERSION }})
          - [å®‰è£æŒ‡å—](https://github.com/doggy8088/ReplaceText/blob/main/docs/INSTALL.md)

          ### ğŸ“š èªªæ˜æ–‡ä»¶

          å®Œæ•´èªªæ˜æ–‡ä»¶è«‹åƒé–± [README.md](https://github.com/doggy8088/ReplaceText/blob/main/README.md)
        draft: false
        prerelease: false
        artifacts: ${{ steps.pack.outputs.NUPKG_PATH }}

    - name: âœ… ç™¼ä½ˆå®Œæˆ (åƒ…åœ¨ NuGet å°šæœªæœ‰æ­¤ç‰ˆæœ¬æ™‚åŸ·è¡Œ)
      if: steps.check_nuget.outputs.exists == 'false'
      run: |
        echo "âœ… å¥—ä»¶å·²æˆåŠŸç™¼ä½ˆåˆ° NuGet.org"
        echo "ğŸ“¦ ç‰ˆæœ¬: ${{ steps.get_version.outputs.VERSION }}"
        echo "ğŸ”— å¥—ä»¶é€£çµ: https://www.nuget.org/packages/Duotify.ReplaceText/${{ steps.get_version.outputs.VERSION }}"

  release_builds:
    name: Build and Release Platform Binaries
    runs-on: windows-latest
    needs: publish
    # Run this job either when the workflow was triggered by a GitHub Release
    # event, or when the publish job created a Release as part of this run.
    if: ${{ github.event_name == 'release' || needs.publish.outputs.release_created == 'true' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore ${{ env.PROJECT_PATH }}

    - name: Build
      run: dotnet build ${{ env.PROJECT_PATH }} --no-restore --configuration Release

    - name: Publish for Windows x64
      run: dotnet publish ${{ env.PROJECT_PATH }} -c Release -r win-x64 --self-contained -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true -o ./publish/win-x64

    - name: Publish for Windows x86
      run: dotnet publish ${{ env.PROJECT_PATH }} -c Release -r win-x86 --self-contained -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true -o ./publish/win-x86

    - name: Publish for Linux x64
      run: dotnet publish ${{ env.PROJECT_PATH }} -c Release -r linux-x64 --self-contained -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true -o ./publish/linux-x64

    - name: Publish for macOS x64
      run: dotnet publish ${{ env.PROJECT_PATH }} -c Release -r osx-x64 --self-contained -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true -o ./publish/osx-x64

    - name: Publish for macOS ARM64
      run: dotnet publish ${{ env.PROJECT_PATH }} -c Release -r osx-arm64 --self-contained -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true -o ./publish/osx-arm64

    - name: Create ZIP archives
      run: |
        Compress-Archive -Path ./publish/win-x64/* -DestinationPath ./ReplaceText-win-x64.zip
        Compress-Archive -Path ./publish/win-x86/* -DestinationPath ./ReplaceText-win-x86.zip
        Compress-Archive -Path ./publish/linux-x64/* -DestinationPath ./ReplaceText-linux-x64.zip
        Compress-Archive -Path ./publish/osx-x64/* -DestinationPath ./ReplaceText-osx-x64.zip
        Compress-Archive -Path ./publish/osx-arm64/* -DestinationPath ./ReplaceText-osx-arm64.zip

    - name: Upload Release Assets
      uses: softprops/action-gh-release@v1
      with:
        # Determine which tag to target: when triggered by a release event
        # use the release's tag name; otherwise use the tag we created in
        # the publish job (v{version}).
        tag_name: ${{ github.event_name == 'release' && github.event.release.tag_name || format('v{0}', needs.publish.outputs.version) }}
        files: |
          ReplaceText-win-x64.zip
          ReplaceText-win-x86.zip
          ReplaceText-linux-x64.zip
          ReplaceText-osx-x64.zip
          ReplaceText-osx-arm64.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # When we created a Release in this job, mark a job-level output so
    # other jobs can detect it. This step only runs when the check determined
    # the version did not already exist and we therefore created the Release.
    - name: "ğŸ”– è¨­å®š release_created è¼¸å‡º (è®“å¾ŒçºŒ job çŸ¥é“å·²å»ºç«‹ Release)"
      id: set_release_created
      if: steps.check_nuget.outputs.exists == 'false'
      run: |
        echo "release_created=true" >> $GITHUB_OUTPUT
