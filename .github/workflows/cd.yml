name: CD - Publish to NuGet

on:
  push:
    tags:
      - 'v*'  # ç•¶æ¨é€ v é–‹é ­çš„æ¨™ç±¤æ™‚è§¸ç™¼ (ä¾‹å¦‚: v2.0.0, v2.1.0)
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

env:
  DOTNET_VERSION: '8.0.x'
  PROJECT_PATH: 'ReplaceText/ReplaceText.csproj'
  PACKAGE_OUTPUT_DIR: 'ReplaceText/nupkg'

jobs:
  publish:
    name: Build and Publish to NuGet
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout ç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # å®Œæ•´çš„ Git æ­·å²è¨˜éŒ„ï¼Œç”¨æ–¼ç‰ˆæœ¬è™Ÿç”Ÿæˆ

    - name: ğŸ”§ è¨­å®š .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ğŸ“ å–å¾—ç‰ˆæœ¬è™Ÿ
      id: get_version
      run: |
        if [[ $GITHUB_REF == refs/tags/v* ]]; then
          VERSION=${GITHUB_REF#refs/tags/v}
        else
          VERSION="1.0.0-dev.${{ github.run_number }}"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ“¦ ç‰ˆæœ¬è™Ÿ: $VERSION"

    - name: ğŸ”¨ é‚„åŸç›¸ä¾å¥—ä»¶
      run: dotnet restore ${{ env.PROJECT_PATH }}

    - name: ğŸ—ï¸ å»ºæ§‹å°ˆæ¡ˆ
      run: dotnet build ${{ env.PROJECT_PATH }} -c Release --no-restore

    - name: ğŸ“¦ æ‰“åŒ… NuGet å¥—ä»¶
      run: |
        dotnet pack ${{ env.PROJECT_PATH }} \
          -c Release \
          --no-build \
          --no-restore \
          -o ${{ env.PACKAGE_OUTPUT_DIR }} \
          -p:PackageVersion=${{ steps.get_version.outputs.VERSION }}

    - name: ğŸ“‹ åˆ—å‡ºå¥—ä»¶å…§å®¹
      run: |
        echo "ğŸ” å·²ç”¢ç”Ÿçš„ NuGet å¥—ä»¶ï¼š"
        ls -lh ${{ env.PACKAGE_OUTPUT_DIR }}

    - name: âœ… é©—è­‰å¥—ä»¶å…§å®¹
      run: |
        echo "ğŸ” é©—è­‰ NuGet å¥—ä»¶å…§å®¹..."
        for nupkg in ${{ env.PACKAGE_OUTPUT_DIR }}/*.nupkg; do
          echo "ğŸ“¦ å¥—ä»¶: $(basename $nupkg)"
          unzip -l "$nupkg" | grep -E '\.(dll|exe|pdb)$' || true
        done

    - name: ğŸš€ ç™¼ä½ˆåˆ° NuGet.org
      if: startsWith(github.ref, 'refs/tags/v')
      run: |
        dotnet nuget push "${{ env.PACKAGE_OUTPUT_DIR }}/*.nupkg" \
          --api-key ${{ secrets.NUGET_API_KEY }} \
          --source https://api.nuget.org/v3/index.json \
          --skip-duplicate

    - name: ğŸ“¤ ä¸Šå‚³å¥—ä»¶ä½œç‚º Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: nuget-package-${{ steps.get_version.outputs.VERSION }}
        path: ${{ env.PACKAGE_OUTPUT_DIR }}/*.nupkg
        retention-days: 90

    - name: ğŸ“ å»ºç«‹ GitHub Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ env.PACKAGE_OUTPUT_DIR }}/*.nupkg
        generate_release_notes: true
        body: |
          ## ğŸ‰ Duotify.ReplaceText ${{ steps.get_version.outputs.VERSION }} å·²ç™¼ä½ˆï¼

          ### å®‰è£æ–¹å¼

          ```bash
          dotnet tool install --global Duotify.ReplaceText
          ```

          ### æ›´æ–°æ–¹å¼

          ```bash
          dotnet tool update --global Duotify.ReplaceText
          ```

          ### ğŸ“¦ å¥—ä»¶é€£çµ

          - [NuGet Gallery](https://www.nuget.org/packages/Duotify.ReplaceText/${{ steps.get_version.outputs.VERSION }})
          - [å®‰è£æŒ‡å—](https://github.com/doggy8088/ReplaceText/blob/main/INSTALL.md)

          ### ğŸ“š èªªæ˜æ–‡ä»¶

          å®Œæ•´èªªæ˜æ–‡ä»¶è«‹åƒé–± [README.md](https://github.com/doggy8088/ReplaceText/blob/main/README.md)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: âœ… ç™¼ä½ˆå®Œæˆ
      if: startsWith(github.ref, 'refs/tags/v')
      run: |
        echo "âœ… å¥—ä»¶å·²æˆåŠŸç™¼ä½ˆåˆ° NuGet.org"
        echo "ğŸ“¦ ç‰ˆæœ¬: ${{ steps.get_version.outputs.VERSION }}"
        echo "ğŸ”— å¥—ä»¶é€£çµ: https://www.nuget.org/packages/Duotify.ReplaceText/${{ steps.get_version.outputs.VERSION }}"
